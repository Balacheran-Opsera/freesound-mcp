{% extends "base.html" %}

{% load static %}
{% load util %}
{% load search %}
{% load bw_templatetags %}
{% load display_sound %}

{% block title %}Search{% endblock %}

{% block navbar %}{% include 'molecules/navbar_search_page.html' %}{% endblock %}

{% block content %}

    <div class="container">
    {% if error_text %}
        <div class="navbar-space-filler v-spacing-3 v-spacing-top-3">
            <div class="v-spacing-6 v-spacing-top-4">
                <p>{{ error_text }}</p>
            </div>
        </div>

    {% else %}
        <div class="navbar-space-filler v-spacing-3 v-spacing-top-3">
            <form method="get" action="/search/">

                <div class="v-spacing-6 v-spacing-top-4">
                    <div class="between middle">
                        <div></div>
                        <input name="q" type="text" value="{{ search_query }}" placeholder="Start browsing here" class="bw-search__input"  id="search-input-browse" autocomplete="off" />
                        <span class="bw-search_remove-query" id="remove-content-search">{% bw_icon 'close' %}</span>
                    </div>
                </div>

                <div>
                    <div class="divider-light"></div>
                    <div class="padding-3 v-padding-2 between font-weight-bold">
                        <div>{% if non_grouped_number_of_results > 0 %}{{ non_grouped_number_of_results }}{% else %}{{ paginator.count }}{% endif %} sounds</div>
                        <div class="bw_search-tab">
                            {% comment %}Sounds{% endcomment %}
                            {% comment %}This section will allow to choose between different search modes: sounds and packs.
                            However, this is currently not implemented in the backend so we put nothing here as only
                            the "sounds" option is supported.
                            {% endcomment %}
                        </div>
                        <div class="browse__search-overview-sorter">
                            <span class="font-weight-normal text-light-grey">Sort by:</span>
                            <select name="s" id="sort-by" onchange="submit();">
                                {% for option in sort_options %}
                                    <option value="{{option.1}}"{% ifequal option.1 sort.0 %}selected="selected"{% endifequal %}>{{option.0}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="divider-light"></div>
                </div>

            </form>
        </div>
        <div class="row no-gutters">
            <aside class="col-sm-12 col-md-3">
                {% if facets.license and facets.license|length > 1 %}
                    {% display_facet "license" facets.license "list" "Licesnes" %}
                {% endif %}

                {% if facets.type and facets.type|length > 1 %}
                    {% display_facet "type" facets.type "list" "Type" %}
                {% endif %}

                {% if facets.tag and facets.tag|length > 1 %}
                    {% display_facet "tag" facets.tag "cloud" "Related Tags" %}
                {% endif %}

                {% if facets.samplerate and facets.samplerate|length > 1 %}
                    {% display_facet "samplerate" facets.samplerate "list" "Samplerate" %}
                {% endif %}

                {% if facets.bitdepth and facets.bitdepth|length > 1 %}
                    {% display_facet "bitdepth" facets.bitdepth "list" "Bitdepth" %}
                {% endif %}

                {% if facets.bitrate and facets.bitrate|length > 1 %}
                    {% display_facet "bitrate" facets.bitrate "list" "Bitrate" %}
                {% endif %}

                {% if facets.channels and facets.channels|length > 1 %}
                    {% display_facet "channels" facets.channels "list" "Channels" %}
                {% endif %}

                {% if facets.grouping_pack and facets.grouping_pack|length > 1 %}
                    {% display_facet "grouping_pack" facets.grouping_pack "list" "Packs"%}
                {% endif %}

                {% if facets.username and facets.username|length > 1 %}
                    {% display_facet "username" facets.username "cloud" "Related users" %}
                {% endif %}
            </aside>
            <main class="col-sm-12 col-md-8 offset-md-1">
                <div class="v-spacing-3 v-spacing-top-1">
                    {% for filter in filter_query_split %}
                        <a class="no-hover" href=".?g={{grouping}}&q={{search_query}}&f={{ filter.remove_url }}" title="Remove this filter">
                            <button class="btn-inverse bw-search__active-filters-button">
                                {{ filter.name }}<span class="h-spacing-left-1">{% bw_icon 'close' %} </span>
                            </button>
                        </a>
                    {% endfor %}
                </div>
                {% if paginator.count > 0 %}
                    <div class="v-spacing-6">
                    {% for result in docs %}
                        <div class="bw-search__result">
                            {% display_sound_middle result.sound %}
                            {% if result.more_from_pack %}
                                <p class="text-grey text-right v-spacing-top-negative-2">
                                    {% bw_icon 'plus' %} <a href='{% url "sounds-search"  %}?q={{ search_query }}&f=grouping_pack:"{{ result.pack_id }}_{{ result.pack_name }}" {{filter_query_link_more_when_grouping_packs }}&s="{{ sort.0 }}"&g={{ grouping }}&advanced={{ advanced }}&a_tag={{ a_tag }}&a_filename={{ a_filename }}&a_description={{ a_description }}&a_packname={{ a_packname }}&a_soundid={{ a_soundid }}&a_username={{ a_username }}'>{{result.more_from_pack}} more result{{ result.more_from_pack|pluralize  }} from the same pack</a> "{{ result.pack_name|truncate_string:35 }}"
                                </p>
                            {% endif %}
                            {% if not forloop.last %}
                                <div class="divider-light"></div>
                            {% endif %}
                        </div>
                    {% endfor %}
                    </div>
                    <div class="">
                        {% bw_paginator paginator page current_page request "sound" non_grouped_number_of_results %}
                    </div>
                {% else %}
                    <div class="v-spacing-6" style="text-align: center;">
                        <h5>No results... &#128543</h5>
                        <p class="text-grey v-spacing-2">Please try another query or change the filters</p>
                    </div>
                {% endif %}
                </div>
            </main>
        </div>
    </div>
    {% endif %}

{% endblock %}

{% block extrabody %}
    <script src="{% static 'bw-frontend/dist/search.735996ae.js' %}"></script>
    <script src="{% static 'bw-frontend/dist/select.9252c69b.js' %}"></script>
{% endblock %}